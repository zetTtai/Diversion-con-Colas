<!DOCTYPE html>
<html lang="en">
<head>
    <title>FWQ_Frontend</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
</head>
<body style="background-color: rgb(23, 26, 30); min-height: 100vh;">
<style>
    .map {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row;
        justify-content: center;
        align-items: baseline;
        align-content: start;
    }
    .cell {
        flex: 0 1 5%;
        width: 40px;
        height: 40px;
        background-color: black;
        align-self: center;
        display: flex;
        justify-content: center;
        align-content: center;
        flex-direction: column;
        border: 1px solid rgb(61, 61, 61);
    }
    p {
        margin: 0px;
    }
</style>
<div class="container-fluid" style="min-height: 90vh;">
    <div class="row content text-center" style="min-height: 90vh;">
        <div class="col-sm-2 sidenav text-white"  style="background-color: rgb(28, 31, 35); min-height: 90vh;">
            <h3 class="text-white mt-4">Atracciones</h3>
            <div>
                <table id="tableAtracciones"  class="m-auto">
                    <tr>
                      <th>Id</th>
                      <th>Tiempo de Espera</th>
                      <th>Posicion</th>
                    </tr>
                </table>
            </div>

            <h3 class="text-white mt-5">Visitantes</h3>
            <div>
                <table id="tableVisitantes"  class="m-auto">
                    <tr>
                      <th>Id</th>
                      <th>Position</th>
                    </tr>
                </table>
            </div>


            <h3 class="text-white mt-5">Tiempo atmosfÃ©rico</h3>
            <div class="text-center">
                <table id="tableWeather" class="m-auto">
                    <tr>
                      <th>Ciudad</th>
                      <th>Temperatura</th>
                    </tr>
                </table>
            </div>

        </div>

        <div class="col-sm-10 mt-3">
            <div id="map" class="map">

            </div>
        </div>
    </div>
</div>

<footer class="container-fluid text-center text-white">
  <h4>Jose Luis Silvestre GarcÃ­a y RaÃºl BeltrÃ¡n Marco</h4>
</footer>

<script>
    const TEMP_LIMIT = 27;
    const BG_COLOR_DISABLED = '#fc9b90';
    const BG_COLOR_ENABLED = ['#212529', '#212529', '#212529', '#212529'];
    const BG_COLOR_ATRACCIONES = '#ffc107';
    const APICall = async () => {
        try {
            const response = await fetch('https://%%IP%%:%%PORT%%/map');
            const json = await response.json(); //extract JSON from the http response
            console.log(json);

            if (response.ok) {
                const visitors = json.visitantes;
                const atracciones = json.atracciones;
                const weather = json.weather;

                PopulateTables(visitors, atracciones, weather);
                PopulateMap(visitors, atracciones, weather);
            } else {
                console.error("Se ha producido un error al obtener los datos de FWQ_Engine");
            }
        } catch (error) {
            console.error("Parece que el FWQ_Frontend no está funcionando");
        }
    }

    function PopulateTables(visitors, atracciones, weather) {
        const tableVisitantes = document.getElementById('tableVisitantes');
        const tableAtracciones = document.getElementById('tableAtracciones');
        const tableWeather = document.getElementById('tableWeather');

        $('#tableAtracciones tr:not(:first)').remove();
        for (let i = 0; i < atracciones.length; i++) {
            const row = tableAtracciones.insertRow(i + 1);
            const cell1 = row.insertCell(0);
            cell1.appendChild(document.createTextNode(atracciones[i].id));
            const cell2 = row.insertCell(1);
            cell2.appendChild(document.createTextNode(atracciones[i].tiempo));
            const cell3 = row.insertCell(2);
            cell3.appendChild(document.createTextNode(atracciones[i].X + ',' + atracciones[i].Y));
        }

        $('#tableVisitantes tr:not(:first)').remove();
        for (let i = 0; i < visitors.length; i++) {
            const row = tableVisitantes.insertRow(i + 1);
            const cell1 = row.insertCell(0);
            //var aux = document.createElement("div");
            //aux.style = "width: 10px; height: 10px; background-color: " + visitors[i].id + ";"
            //aux.appendChild(document.createTextNode(visitors[i].id));
            //cell1.appendChild(aux);
            cell1.appendChild(document.createTextNode(visitors[i].id));
            cell1.style.color = visitors[i].id;
            const cell2 = row.insertCell(1);
            cell2.appendChild(document.createTextNode(visitors[i].X + "," + visitors[i].Y));
        }

        $('#tableWeather tr:not(:first)').remove();
        for (let i = 1; i <= 4; i++) {
            const row = tableWeather.insertRow(i);
            const cell1 = row.insertCell(0);
            cell1.appendChild(document.createTextNode(weather["ciudad"+i].nombre));
            const cell2 = row.insertCell(1);
            cell2.appendChild(document.createTextNode(weather["ciudad"+i].temp));
        }

    }

    function PopulateMap(visitors, atracciones, weather) { 

        var map = document.getElementById("map");
        for(let i = 0; i < 20; i++) {
            for(let j = 0; j < 20; j++){
                var cell = document.getElementById(i + "," + j);
                var cuadrante = Cuadrante(i, j);
                var temp = weather["ciudad" + cuadrante].temp;
                cell.style.backgroundColor = temp > TEMP_LIMIT ? BG_COLOR_DISABLED : BG_COLOR_ENABLED[cuadrante - 1];
            }
        }

        for (let i = 0; i < visitors.length; i++) {
            var cell = document.getElementById(visitors[i].X + "," + visitors[i].Y);
            cell.style.backgroundColor = visitors[i].id;
            if(cell.childNodes.length == 0) {
                var aux = document.createElement("p");
                aux.appendChild(document.createTextNode("V"));
                cell.appendChild(aux);
            }
        }

        for (let i = 0; i < atracciones.length; i++) {
            var cell = document.getElementById(atracciones[i].X + "," + atracciones[i].Y);
            cell.style.backgroundColor = BG_COLOR_ATRACCIONES;
            if(cell.childNodes.length == 0) {
                var aux = document.createElement("p");
                aux.appendChild(document.createTextNode("A" + atracciones[i].id.replace(/\D/g, "") + " (" + atracciones[i].tiempo + ")"));
                cell.appendChild(aux);
            }
        }

    }

    function Cuadrante(i, j){
        if(i < 10 && j < 10) {
            return 1;
        } else if(i < 10 && j >= 10) {
            return 2;
        } else if(i >= 10 && j < 10) {
            return 3;
        } else {
            return 4;
        }
    }

    function CreateMap(){
        var map = document.getElementById("map");
        
        for(let i = 0; i < 20; i++){
            for(let j = 0; j < 20; j++){
                var div = document.createElement("div");
                div.className = "cell";
                div.id = i + ',' + j;
                map.appendChild(div);
            }
        }

    }

    setInterval(APICall, 1000);
    CreateMap();
</script>

</body>
</html>
